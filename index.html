<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PURL Parser & Validator - Enhanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .version-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-top: 10px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            transition: border-color 0.3s;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .examples {
            margin-top: 10px;
            font-size: 0.9em;
            color: #666;
        }
        
        .example-link {
            color: #667eea;
            cursor: pointer;
            text-decoration: underline;
            margin-right: 15px;
        }
        
        .example-link:hover {
            color: #764ba2;
        }
        
        .result {
            margin-top: 20px;
        }
        
        .error {
            background: #fee;
            border-left: 4px solid #f44;
            padding: 15px;
            border-radius: 6px;
            color: #c33;
        }
        
        .success {
            background: #efe;
            border-left: 4px solid #4c4;
            padding: 15px;
            border-radius: 6px;
            color: #363;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 6px;
            color: #856404;
            margin-bottom: 15px;
        }
        
        .warning-title {
            font-weight: 600;
            margin-bottom: 8px;
        }
        
        .warning-list {
            margin-left: 20px;
            margin-top: 8px;
        }
        
        .validation-level {
            font-size: 0.85em;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .validation-enhanced {
            background: #d4edda;
            color: #155724;
        }
        
        .validation-basic {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .component {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        
        .component-label {
            font-weight: 600;
            color: #667eea;
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .component-value {
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            color: #333;
            word-break: break-all;
        }
        
        .component-empty {
            color: #999;
            font-style: italic;
        }
        
        .component-note {
            margin-top: 8px;
            font-size: 0.9em;
            color: #666;
            font-style: italic;
        }
        
        .repo-link {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 16px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9em;
            transition: background 0.3s;
        }
        
        .repo-link:hover {
            background: #764ba2;
        }
        
        .qualifiers {
            margin-top: 8px;
        }
        
        .qualifier-item {
            display: inline-block;
            background: #e8eaf6;
            padding: 4px 10px;
            border-radius: 4px;
            margin-right: 8px;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .qualifier-key {
            color: #667eea;
            font-weight: 600;
        }
        
        .footer {
            text-align: center;
            color: white;
            margin-top: 30px;
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .footer a {
            color: white;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì¶ PURL Parser & Validator</h1>
            <p>Parse and validate Package URLs (PURL) with type-specific validation</p>
            <div class="version-badge">Enhanced with PyPI validation</div>
        </div>
        
        <div class="card">
            <div class="input-group">
                <label for="purlInput">Enter a Package URL (PURL):</label>
                <input 
                    type="text" 
                    id="purlInput" 
                    placeholder="pkg:pypi/django@3.2.0"
                    autocomplete="off"
                />
                <div class="examples">
                    Try PyPI: 
                    <span class="example-link" onclick="loadExample('pkg:pypi/django@3.2.0')">django</span>
                    <span class="example-link" onclick="loadExample('pkg:pypi/requests@2.28.1')">requests</span>
                    <span class="example-link" onclick="loadExample('pkg:pypi/Flask-SQLAlchemy@2.5.1')">Flask-SQLAlchemy</span>
                    <span class="example-link" onclick="loadExample('pkg:pypi/numpy@1.23.0?extension=tar.gz')">with qualifier</span>
                    <span class="example-link" onclick="loadExample('pkg:pypi/Django/admin@3.2.0')">‚ö†Ô∏è invalid</span>
                </div>
            </div>
            
            <div id="result" class="result"></div>
        </div>
        
        <div class="footer">
            Learn more about PURL at <a href="https://github.com/package-url/purl-spec" target="_blank">github.com/package-url/purl-spec</a>
        </div>
    </div>

    <script>
        // PyPI-specific validation rules
        function validatePyPI(parsed) {
            const warnings = [];
            
            // PyPI doesn't use namespace
            if (parsed.namespace) {
                warnings.push('PyPI packages should not have a namespace. The namespace will be ignored.');
            }
            
            // PyPI package names should be normalized (lowercase, hyphens instead of underscores)
            const name = parsed.name;
            const normalizedName = name.toLowerCase().replace(/_/g, '-');
            
            if (name !== normalizedName) {
                warnings.push(`PyPI package names should be normalized. Suggested: "${normalizedName}"`);
            }
            
            // Check for uppercase in name
            if (name !== name.toLowerCase()) {
                warnings.push('PyPI package names are case-insensitive and typically lowercase.');
            }
            
            // Version format check (basic PEP 440 validation)
            if (parsed.version) {
                const validVersionPattern = /^(\d+!)?\d+(\.\d+)*((a|alpha|b|beta|rc|c|pre|preview)\d+)?(\.post\d+)?(\.dev\d+)?$/i;
                if (!validVersionPattern.test(parsed.version)) {
                    warnings.push('Version format may not comply with PEP 440 standard.');
                }
            }
            
            // Check qualifiers
            if (parsed.qualifiers) {
                const validPyPIQualifiers = ['extension', 'repository_url'];
                for (const key of Object.keys(parsed.qualifiers)) {
                    if (!validPyPIQualifiers.includes(key)) {
                        warnings.push(`Qualifier "${key}" is not commonly used in PyPI PURLs. Valid qualifiers: ${validPyPIQualifiers.join(', ')}`);
                    }
                }
                
                // Check extension qualifier
                if (parsed.qualifiers.extension) {
                    const validExtensions = ['tar.gz', 'whl', 'egg', 'zip'];
                    if (!validExtensions.includes(parsed.qualifiers.extension)) {
                        warnings.push(`Extension "${parsed.qualifiers.extension}" is uncommon. Typical extensions: ${validExtensions.join(', ')}`);
                    }
                }
            }
            
            return warnings;
        }
        
        function parsePURL(purl) {
            // Basic PURL regex pattern
            const purlPattern = /^pkg:([^\/]+)\/(.+)$/;
            
            if (!purl || purl.trim() === '') {
                return { error: 'Please enter a PURL' };
            }
            
            if (!purl.startsWith('pkg:')) {
                return { error: 'PURL must start with "pkg:"' };
            }
            
            const match = purl.match(purlPattern);
            if (!match) {
                return { error: 'Invalid PURL format. Expected: pkg:type/name@version' };
            }
            
            const type = match[1].toLowerCase();
            const remainder = match[2];
            
            // Split by # for subpath
            const [beforeSubpath, subpath] = remainder.split('#');
            
            // Split by ? for qualifiers
            const [beforeQualifiers, qualifiersStr] = beforeSubpath.split('?');
            
            // Parse qualifiers
            const qualifiers = {};
            if (qualifiersStr) {
                qualifiersStr.split('&').forEach(q => {
                    const [key, value] = q.split('=');
                    if (key && value) {
                        qualifiers[decodeURIComponent(key)] = decodeURIComponent(value);
                    }
                });
            }
            
            // Split by @ for version (from the right to handle namespaces with @)
            const lastAtIndex = beforeQualifiers.lastIndexOf('@');
            let namespaceName, version;
            
            if (lastAtIndex > 0) {
                namespaceName = beforeQualifiers.substring(0, lastAtIndex);
                version = beforeQualifiers.substring(lastAtIndex + 1);
            } else {
                namespaceName = beforeQualifiers;
                version = null;
            }
            
            // Split namespace and name
            const parts = namespaceName.split('/');
            let namespace, name;
            
            if (parts.length > 1) {
                name = parts.pop();
                namespace = parts.join('/');
            } else {
                namespace = null;
                name = parts[0];
            }
            
            const parsed = {
                valid: true,
                type,
                namespace: namespace || null,
                name: decodeURIComponent(name),
                version: version || null,
                qualifiers: Object.keys(qualifiers).length > 0 ? qualifiers : null,
                subpath: subpath || null
            };
            
            // Add type-specific validation
            if (type === 'pypi') {
                parsed.warnings = validatePyPI(parsed);
                parsed.validationLevel = 'enhanced';
            } else {
                parsed.validationLevel = 'basic';
            }
            
            return parsed;
        }
        
        function getRepositoryLink(parsed) {
            const { type, namespace, name, version } = parsed;
            
            const links = {
                'npm': `https://www.npmjs.com/package/${name}${version ? `/v/${version}` : ''}`,
                'pypi': `https://pypi.org/project/${name}${version ? `/${version}` : ''}/`,
                'maven': namespace ? `https://search.maven.org/artifact/${namespace}/${name}${version ? `/${version}` : ''}/jar` : null,
                'cargo': `https://crates.io/crates/${name}${version ? `/${version}` : ''}`,
                'gem': `https://rubygems.org/gems/${name}${version ? `/versions/${version}` : ''}`,
                'nuget': `https://www.nuget.org/packages/${name}${version ? `/${version}` : ''}`,
                'composer': namespace ? `https://packagist.org/packages/${namespace}/${name}` : null,
                'docker': `https://hub.docker.com/r/${namespace || 'library'}/${name}`,
                'github': namespace ? `https://github.com/${namespace}/${name}` : null,
            };
            
            return links[type] || null;
        }
        
        function displayResult(parsed) {
            const resultDiv = document.getElementById('result');
            
            if (parsed.error) {
                resultDiv.innerHTML = `<div class="error"><strong>Error:</strong> ${parsed.error}</div>`;
                return;
            }
            
            const repoLink = getRepositoryLink(parsed);
            
            let html = `
                <div class="success">
                    <span><strong>‚úì Valid PURL</strong></span>
                    <span class="validation-level validation-${parsed.validationLevel}">
                        ${parsed.validationLevel === 'enhanced' ? 'üîç Enhanced Validation' : 'Basic Validation'}
                    </span>
                </div>
            `;
            
            // Show warnings if any
            if (parsed.warnings && parsed.warnings.length > 0) {
                html += '<div class="warning">';
                html += '<div class="warning-title">‚ö†Ô∏è Validation Warnings:</div>';
                html += '<div class="warning-list">';
                parsed.warnings.forEach(warning => {
                    html += `<div>‚Ä¢ ${warning}</div>`;
                });
                html += '</div></div>';
            }
            
            html += `
                <div class="component">
                    <div class="component-label">Scheme</div>
                    <div class="component-value">pkg:</div>
                </div>
                
                <div class="component">
                    <div class="component-label">Type</div>
                    <div class="component-value">${parsed.type}</div>
                    ${parsed.type === 'pypi' ? '<div class="component-note">‚úì PyPI-specific validation enabled</div>' : ''}
                </div>
            `;
            
            if (parsed.namespace) {
                html += `
                    <div class="component">
                        <div class="component-label">Namespace</div>
                        <div class="component-value">${parsed.namespace}</div>
                        ${parsed.type === 'pypi' ? '<div class="component-note">‚ö†Ô∏è PyPI typically does not use namespaces</div>' : ''}
                    </div>
                `;
            }
            
            html += `
                <div class="component">
                    <div class="component-label">Name</div>
                    <div class="component-value">${parsed.name}</div>
                    ${parsed.type === 'pypi' ? '<div class="component-note">PyPI names are case-insensitive and normalized</div>' : ''}
                </div>
            `;
            
            if (parsed.version) {
                html += `
                    <div class="component">
                        <div class="component-label">Version</div>
                        <div class="component-value">${parsed.version}</div>
                        ${parsed.type === 'pypi' ? '<div class="component-note">Should follow PEP 440 versioning standard</div>' : ''}
                    </div>
                `;
            }
            
            if (parsed.qualifiers) {
                let qualifiersHtml = '<div class="qualifiers">';
                for (const [key, value] of Object.entries(parsed.qualifiers)) {
                    qualifiersHtml += `<span class="qualifier-item"><span class="qualifier-key">${key}</span>=${value}</span>`;
                }
                qualifiersHtml += '</div>';
                
                html += `
                    <div class="component">
                        <div class="component-label">Qualifiers</div>
                        ${qualifiersHtml}
                        ${parsed.type === 'pypi' ? '<div class="component-note">Common: extension (tar.gz, whl, egg), repository_url</div>' : ''}
                    </div>
                `;
            }
            
            if (parsed.subpath) {
                html += `
                    <div class="component">
                        <div class="component-label">Subpath</div>
                        <div class="component-value">${parsed.subpath}</div>
                    </div>
                `;
            }
            
            if (repoLink) {
                html += `
                    <div class="component">
                        <div class="component-label">Repository Link</div>
                        <a href="${repoLink}" target="_blank" class="repo-link">View Package ‚Üí</a>
                    </div>
                `;
            }
            
            resultDiv.innerHTML = html;
        }
        
        function loadExample(examplePurl) {
            document.getElementById('purlInput').value = examplePurl;
            const parsed = parsePURL(examplePurl);
            displayResult(parsed);
        }
        
        // Real-time parsing
        document.getElementById('purlInput').addEventListener('input', (e) => {
            const purl = e.target.value;
            if (purl.trim()) {
                const parsed = parsePURL(purl);
                displayResult(parsed);
            }
        });
        
        // Load first example on page load
        window.addEventListener('load', () => {
            loadExample('pkg:pypi/django@3.2.0');
        });
    </script>
</body>
</html>